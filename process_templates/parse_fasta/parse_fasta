[% INCLUDE 'setup/Perl' %]

[%# ROME Variables, defined by setup/R:
   $rome_userdir
   $rome_username  
   $rome_experiment_name 

%]

[%# TT Arguments from Processor
    rome_datafiles_out
    rome_datafiles_in
%]

[%# TT Arguments from controller 
  filenames : an array reference
%]

use File::chdir;
use Bio::SeqIO;
use JSON;

{
  #upload files should be in the upload directory.
  \$CWD = "uploads";
  
  #Open your datafile for appending sequences
  my \$outfile = Bio::SeqIO->new(-file=> "> ../[% rome_datafiles_out.FASTA.name %]", -format=>'fasta');

  #for each selected file
  my @files = qw([% filenames.join(' ')%]);
  foreach (@files){
    #for each of the sequences in that file
    my \$iter = Bio::SeqIO->new(-file => "<\$_", -format=>'fasta');
    while (my \$seq = \$iter->next_seq){
      #write the sequence to the output file
      \$outfile->write_seq($seq);

      #spit out some JSON to the log file to create outcomes      
      my \$outcome = {
		      outcome_name => \$seq->display_id,
		      outcome_experiment_name => \$rome_experiment_name,
		      outcome_experiment_owner => \$rome_experiment_owner,
		      datafile_name => "[% rome_datafiles_out.FASTA.name %]",
		      datafile_experiment_name => "[% rome_datafiles_out.FASTA.experiment_name %]",
		      datafile_experiment_owner => "[% rome_datafiles_out.FASTA.experiment_owner%]",
		    };
      my \$json = encode_json \$outcome;
      print "START_JSON\n\$json\nSTOP_JSON\n";
    }
  }
}

